# Taskon 空投合约第三方部署指南

## 概述

本文档适用于需要部署 Taskon 空投合约但没有源代码访问权限的第三方。通过使用已编译的合约 ABI 和字节码，您可以完成部署过程。

## 目录

- [准备工作](#准备工作)
- [部署 AirdropFactory](#部署-airdropfactory)
- [创建空投池](#创建空投池)
- [合约交互](#合约交互)
- [常见问题](#常见问题)

## 准备工作

### 所需工具

- MetaMask 或其他以太坊钱包
- 足够的原生代币（ETH、BNB、MATIC 等）用于支付 Gas 费用
- 区块链浏览器（Etherscan、BscScan、PolygonScan 等）

### 获取合约文件

从 Taskon 团队获取以下文件：

1. `AirdropFactory.json` - 包含工厂合约的 ABI 和字节码
2. `AirdropPool.json` - 包含空投池合约的 ABI 和字节码
3. `ERC1967Proxy.json` - 包含代理合约的 ABI 和字节码

## 部署 AirdropFactory

### 使用 Remix 部署（推荐新手使用）

1. 访问 [Remix IDE](https://remix.ethereum.org/)

2. 创建新文件并导入合约 JSON 文件
   - 点击左侧的 "File explorers" 图标
   - 创建新文件 `AirdropFactory.json` 并粘贴内容
   - 创建新文件 `ERC1967Proxy.json` 并粘贴内容

3. 部署 AirdropFactory 实现合约
   - 切换到 "Deploy & Run Transactions" 选项卡
   - 在 "ENVIRONMENT" 下拉菜单中选择 "Injected Provider - MetaMask"
   - 在 "CONTRACT" 下拉菜单中选择 "AirdropFactory - AirdropFactory.json"
   - 点击 "Deploy" 按钮
   - 确认 MetaMask 交易并等待部署完成
   - 记录部署的合约地址（称为 `factoryImpl`）

4. 准备初始化数据
   - 在 Remix 控制台中执行以下代码获取初始化数据：
   ```javascript
   // 将 YOUR_OWNER_ADDRESS 替换为您的管理员地址
   const iface = new ethers.utils.Interface(['function initialize(address)']);
   const initData = iface.encodeFunctionData('initialize', ['YOUR_OWNER_ADDRESS']);
   console.log(initData);
   ```
   - 复制输出的初始化数据（称为 `initData`）

5. 部署代理合约
   - 在 "CONTRACT" 下拉菜单中选择 "ERC1967Proxy - ERC1967Proxy.json"
   - 在部署参数中输入 `factoryImpl` 和 `initData`
   - 点击 "Deploy" 按钮
   - 确认 MetaMask 交易并等待部署完成
   - 记录部署的代理合约地址（称为 `factoryProxy`）

### 使用 ethers.js 部署（适合开发者）

```javascript
const { ethers } = require('ethers');
const fs = require('fs');

// 读取合约 JSON 文件
const factoryJson = JSON.parse(fs.readFileSync('AirdropFactory.json'));
const proxyJson = JSON.parse(fs.readFileSync('ERC1967Proxy.json'));

// 连接到区块链网络
const provider = new ethers.providers.JsonRpcProvider('YOUR_RPC_URL');
const wallet = new ethers.Wallet('YOUR_PRIVATE_KEY', provider);

async function deploy() {
  // 部署 AirdropFactory 实现合约
  const FactoryFactory = new ethers.ContractFactory(
    factoryJson.abi,
    factoryJson.bytecode,
    wallet
  );
  const factoryImpl = await FactoryFactory.deploy();
  await factoryImpl.deployed();
  console.log('AirdropFactory 实现合约地址:', factoryImpl.address);

  // 准备初始化数据
  const abiCoder = new ethers.utils.Interface(['function initialize(address)']);
  const initData = abiCoder.encodeFunctionData('initialize', [wallet.address]);

  // 部署代理合约
  const ProxyFactory = new ethers.ContractFactory(
    proxyJson.abi,
    proxyJson.bytecode,
    wallet
  );
  const factoryProxy = await ProxyFactory.deploy(factoryImpl.address, initData);
  await factoryProxy.deployed();
  console.log('AirdropFactory 代理合约地址:', factoryProxy.address);

  // 保存部署信息
  const deployInfo = {
    factoryImpl: factoryImpl.address,
    factoryProxy: factoryProxy.address,
    owner: wallet.address,
    timestamp: new Date().toISOString()
  };
  fs.writeFileSync('deployment-info.json', JSON.stringify(deployInfo, null, 2));
}

deploy().catch(console.error);
```

## 创建空投池

### 使用区块链浏览器创建空投池

1. 访问相应的区块链浏览器（如 Etherscan、BscScan 等）

2. 搜索您部署的 AirdropFactory 代理合约地址

3. 切换到 "Contract" 选项卡，然后点击 "Write Contract"

4. 连接您的钱包（点击 "Connect to Web3"）

5. 找到 `createPool` 函数并填写以下参数：
   - `token`: 空投代币的合约地址
   - `id`: 池 ID（任意唯一数字，如 1、2、3 等）
   - `inFeeRate`: 入金手续费率（以万分比表示，如 100 表示 1%）
   - `outFeeRate`: 出金手续费率（以万分比表示，如 200 表示 2%）
   - `signature`: 如果您是合约管理员，可以输入 "0x"；否则需要管理员提供签名

6. 点击 "Write" 按钮并确认交易

7. 交易确认后，在区块链浏览器中查看交易详情，从 "Logs" 中找到 `AirdropPoolCreated` 事件，记录其中的 `airdropPool` 地址

### 使用 ethers.js 创建空投池

```javascript
const { ethers } = require('ethers');
const fs = require('fs');

// 读取部署信息
const deployInfo = JSON.parse(fs.readFileSync('deployment-info.json'));
const factoryJson = JSON.parse(fs.readFileSync('AirdropFactory.json'));

// 连接到区块链网络
const provider = new ethers.providers.JsonRpcProvider('YOUR_RPC_URL');
const wallet = new ethers.Wallet('YOUR_PRIVATE_KEY', provider);

async function createPool() {
  // 连接到工厂合约
  const factory = new ethers.Contract(
    deployInfo.factoryProxy,
    factoryJson.abi,
    wallet
  );

  // 配置参数
  const tokenAddress = '0x...'; // 替换为空投代币地址
  const poolId = 1; // 池 ID
  const inFeeRate = 100; // 入金手续费率 1%
  const outFeeRate = 200; // 出金手续费率 2%

  // 检查是否是管理员
  const owner = await factory.owner();
  let signature = '0x';

  // 如果不是管理员，需要获取管理员签名
  if (owner.toLowerCase() !== wallet.address.toLowerCase()) {
    console.log('您不是合约管理员，需要管理员签名');
    console.log('请联系管理员获取以下数据的签名:');
    
    const chainId = (await provider.getNetwork()).chainId;
    const message = ethers.utils.solidityKeccak256(
      ['uint256', 'address', 'address', 'uint256', 'uint256', 'uint256'],
      [chainId, factory.address, tokenAddress, poolId, inFeeRate, outFeeRate]
    );
    
    console.log('消息哈希:', message);
    console.log('需要管理员对此消息进行签名');
    
    // 这里应该由管理员提供签名
    // signature = '管理员提供的签名';
    return;
  }

  // 创建空投池
  console.log('创建空投池...');
  const tx = await factory.createPool(
    tokenAddress,
    poolId,
    inFeeRate,
    outFeeRate,
    signature
  );
  
  console.log('交易已提交，等待确认...');
  const receipt = await tx.wait();
  
  // 从事件中获取空投池地址
  const event = receipt.events.find(e => e.event === 'AirdropPoolCreated');
  const poolAddress = event.args.airdropPool;
  
  console.log('空投池创建成功!');
  console.log('空投池地址:', poolAddress);
  
  // 保存池信息
  const poolInfo = {
    factoryAddress: deployInfo.factoryProxy,
    poolAddress: poolAddress,
    tokenAddress: tokenAddress,
    poolId: poolId,
    inFeeRate: inFeeRate,
    outFeeRate: outFeeRate,
    timestamp: new Date().toISOString()
  };
  
  fs.writeFileSync(`pool-${poolId}.json`, JSON.stringify(poolInfo, null, 2));
}

createPool().catch(console.error);
```

## 合约交互

### 向空投池充值代币

1. 使用代币合约的 `transfer` 函数直接向空投池地址转账代币
   - 在代币合约的区块链浏览器页面上
   - 切换到 "Write Contract" 选项卡
   - 连接您的钱包
   - 找到 `transfer` 函数
   - 输入空投池地址和转账金额
   - 点击 "Write" 并确认交易

### 提取未分发的代币（仅限创建者）

1. 在空投池合约的区块链浏览器页面上
2. 切换到 "Write Contract" 选项卡
3. 连接您的钱包（必须是池的创建者）
4. 找到 `withdraw` 函数
5. 输入提取金额和接收地址
6. 点击 "Write" 并确认交易

### 领取空投（需要管理员签名）

用户需要管理员提供签名才能领取空投。管理员需要签署包含以下参数的消息：

- 链 ID
- 空投池地址
- 代币地址
- 用户地址
- 用户当前 nonce
- 领取金额
- 领取 ID
- 过期时间

获得签名后，用户可以通过以下方式领取：

1. 在空投池合约的区块链浏览器页面上
2. 切换到 "Write Contract" 选项卡
3. 连接您的钱包
4. 找到 `claim` 函数（自己领取）或 `claimFor` 函数（为他人领取）
5. 输入相应参数和管理员签名
6. 点击 "Write" 并确认交易

## 常见问题

### 如何获取管理员签名？

联系 Taskon 团队或合约管理员，提供以下信息：
- 链 ID
- 工厂合约地址（用于创建池）或空投池地址（用于领取空投）
- 相关参数（取决于需要签名的操作）

### 如何验证合约？

由于您没有源代码，无法直接在区块链浏览器上验证合约。您可以：
1. 请求 Taskon 团队提供已扁平化的合约代码用于验证
2. 使用合约 ABI 与合约交互，无需验证

### 如何查看空投池余额？

1. 获取空投池使用的代币合约地址
2. 在代币合约的区块链浏览器页面上
3. 切换到 "Read Contract" 选项卡
4. 找到 `balanceOf` 函数
5. 输入空投池地址
6. 点击 "Query" 查看余额

### 如何检查用户是否已领取空投？

1. 在空投池合约的区块链浏览器页面上
2. 切换到 "Read Contract" 选项卡
3. 找到 `lastNonce` 函数
4. 输入用户地址
5. 点击 "Query"
6. 如果返回值大于 0，表示用户已领取过空投 